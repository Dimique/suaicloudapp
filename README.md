# SUAI Cloud App

## Структура репозитория

* `README.md` - файл, который вы сейчас читаете;
* `.gitignore` - файл, содержащий указания относительно того, какие файлы и папки в рабочем каталоге необходимо игнорировать и не помещать в систему контроля версий; например, туда входят файлы .pyc, папка с виртуальным окружением venv/ и другие. Если вы не знаете, редактировать этот файл или нет, - не редактируйте;
* `run.py` - файл, запускающий веб-приложение;
* `app/` - каталог, в котором содержатся файлы с исходным кодом веб-приложения; структура проекта в каталоге app/ выбирается самостоятельно, но должна быть адекватной;
* `scripts/` - каталог, в котором содержатся sql-скрипты: 
  * `init/create_db.sql` - создания БД, 
  * `requests/` - запросов, использующихся в приложении;
* `config.toml` - файл конфигурации веб-приложения, написанный в нотации [TOML](https://ru.wikipedia.org/wiki/TOML);
* `init.sh` - shell-скрипт, инициализирующий окружение, необходимое для запуска веб-приложения.

## Конфигурация приложения

Для корректной работы приложения выполнить найстройку [файла конфигурации](config.toml).

### Структура файла конфигурации
* `server` - параметры веб-серера
  * `host` - ip-адрес запуска сервера (`0.0.0.0` для того, чтобы сервер принимал запросы с любых адресов)
  * `port` - порт, на котором будет работать сервер (`8080` по умолчанию)
  * `CSRF_ENABLED` - включение защиты от [CSRF](https://ru.wikipedia.org/wiki/Межсайтовая_подделка_запроса) атак
  * `SECRET_KEY` - секретный ключ, необходимый для защиты от CSRF атак
* `database` - параметры подключения к БД
  * `host` - адрес подключения
  * `port` - порт подключения
  * `user` - имя пользователя
  * `password` - пароль
  * `dbname` - имя базы данных
* `s3` - параметры S3
  * `bucket` - имя S3 bucket
* `student` - идентификационные данные студента
  * `name` - полное имя студента
  * `group` - группа студента
  * `number` - порядковый номер студента

Пример конфигурации:

```toml
[server]
host = '0.0.0.0'
port = 8080
CSRF_ENABLED = true
SECRET_KEY = '2vm04vn402nfkghbj4vp2n6tnv0'

[database]
host = 'dbtest.clhbct1n77at.eu-central-1.rds.amazonaws.com'
port = 5432
user = 'postgres'
password = 'asdqwe123'
dbname = 'suai'

[s3]
bucket = 'suaicloudbucket'

[student]
name = 'Vitalii Mikhailichenko'
group = '4140M'
number = '11'
```

Предполагается, что после внесения изменений данный файл конфигурации будет загружен в S3 bucket, с которого и будет автоматически скачан на ec2-инстанс.

## Развертывание приложения на облачной платформе AWS

### Настройка окружения

Для корректной работы приложения необходимо подготовить окружение:
* VPC
* S3 bucket
* IAM Role
* RDS

#### VPC

VPC должна содержать не менее двух подсетей, расположенных в различных зонах доступности (AZ). Желательно, чтобы одна из подсетей была приватной (для размещения в ней базы данных).

#### S3 bucket

S3 bucket должен быть приватным и содержать в себе файл скорректированный файл конфигурации. Допускается, что bucket будет содержать весь код приложения - тогда отпадает необходимость клонировать репозиторий с GitHub, однако появляется необходимость самостоятельно обновлять файлы приложения в S3.

#### IAM Role

Роль, применяемая для EC2 машин, должна содержать две политики доступа:
* доступ к S3 bucket
* доступ к RDS инстансу
  
Политики, закрепленные за данной ролью не должны давать доступ к ресурсам, необходимость в которых отсутствует.

#### RDS

Приложение рассчитано на работу с СУБД `postgresql`. Также, нет необходимости в использовании шифорвания и создании бекапов. Доступ к RDS должен быть возможнен только внутри VPC.

### EC2 инстанс

Приложение подготовлено для запуска на `Ubuntu Server 20.04 LTS (HVM)`. Требуемая версия `Python` - 3.8.

Для получения доступа к веб-интерфейсу приложения необходимо открыть порт, указанный в [файле конфигурации](config.toml).

После запуска инстанса и подключения к нему по `SSH`, необходимо выполнить следующие команды для обновления пакетов инстанса и установки приложения:

```bash
sudo apt update -y
sudo apt upgrade -y
sudo apt install awscli -y
sudo apt install python3-pip -y
sudo apt install postgresql-client -y
sudo apt install libpq-dev -y

sudo mkdir /suai
cd /suai/
sudo git clone https://github.com/1k1ru/suaicloudapp.git
cd suaicloudapp/
```
После выполнения данных команд необходимо отредактировать [файл конфигурации config.toml](config.toml) в соответствии с примером конфигурации описаном выше.

```bash
sudo nano config.toml
```

[run.py](run.py) - точка входа приложения. Запуск приложения можно осуществить командой:

```bash
python3 run.py
```

## Веб-интерфейс приложения

### Database check

На странице Database check можно выполнить проверку основного функционала базы данных: получение и помещение данных.

При загрузке страницы будет выведен список студентов, данные о которых уже были помещены в БД.

Также, с помощью функции `Add student` можно добавить в БД еще студентов.

### Health check

В разделе Health check можно выполнить проверку доступности S3 и RDS, а также получить базовую информацию об инстансе, на котором развернуто приложение.

Кнопка `Reload config` позволяет перезагрузить файл конфигурации для обновления, например, для обновления адреса подключения базы данных. Обновления параметров `server` при этом не происходит.  
Кнопка `Recheck S3 access` позволяет перепроверить доступность S3 bucket.  
Кнопка `Reconnect to database` позволяет переподключиться к базе данных.  
Кнопка `Recreate database` позволяет (пере)создать базу данных, стерев все существующие данные в ней.
